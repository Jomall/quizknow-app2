<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>QuizKnow App - Password Reset Test</h1>
        
        <div class="test-section">
            <h2>Test 1: Password Reset Token Generation</h2>
            <input type="email" id="testEmail" placeholder="Enter email" value="test@example.com">
            <button onclick="testTokenGeneration()">Generate Token</button>
            <div id="tokenResult"></div>
        </div>

        <div class="test-section">
            <h2>Test 2: Token Validation</h2>
            <input type="text" id="testToken" placeholder="Enter token">
            <button onclick="testTokenValidation()">Validate Token</button>
            <div id="validationResult"></div>
        </div>

        <div class="test-section">
            <h2>Test 3: Password Update</h2>
            <input type="password" id="newPassword" placeholder="New password">
            <button onclick="testPasswordUpdate()">Update Password</button>
            <div id="updateResult"></div>
        </div>

        <div class="test-section">
            <h2>Test Results Summary</h2>
            <div id="testSummary"></div>
        </div>
    </div>

    <script>
        // Mock implementations of the password reset functionality
        class MockPasswordResetStorage {
            static tokens = [];
            
            static generateToken(email) {
                const token = Math.random().toString(36).substring(2, 15) + 
                              Math.random().toString(36).substring(2, 15);
                return token;
            }
            
            static createToken(email, userId) {
                const token = this.generateToken(email);
                const newToken = {
                    token,
                    email,
                    userId: userId || 'user_' + Date.now(),
                    createdAt: new Date(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 hours
                    used: false,
                };
                this.tokens.push(newToken);
                return token;
            }
            
            static validateToken(token) {
                const resetToken = this.tokens.find(t => t.token === token && !t.used);
                if (!resetToken) return null;
                if (new Date() > new Date(resetToken.expiresAt)) return null;
                return resetToken;
            }
            
            static markTokenAsUsed(token) {
                const tokenIndex = this.tokens.findIndex(t => t.token === token);
                if (tokenIndex === -1) return false;
                this.tokens[tokenIndex].used = true;
                return true;
            }
        }

        class MockUserStorage {
            static users = [
                { id: '1', email: 'test@example.com', name: 'Test User', password: 'oldpassword' }
            ];
            
            static updatePassword(userId, newPassword) {
                const userIndex = this.users.findIndex(u => u.id === userId);
                if (userIndex === -1) return false;
                this.users[userIndex].password = newPassword;
                return true;
            }
            
            static getUser(email) {
                return this.users.find(u => u.email === email);
            }
        }

        let testResults = [];

        function testTokenGeneration() {
            const email = document.getElementById('testEmail').value;
            const resultDiv = document.getElementById('tokenResult');
            
            try {
                const token = MockPasswordResetStorage.createToken(email, 'user_123');
                resultDiv.innerHTML = `<div class="success">✅ Token generated successfully: ${token}</div>`;
                document.getElementById('testToken').value = token;
                testResults.push({ test: 'Token Generation', status: 'PASS', details: `Token: ${token}` });
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Token generation failed: ${error.message}</div>`;
                testResults.push({ test: 'Token Generation', status: 'FAIL', details: error.message });
            }
            updateSummary();
        }

        function testTokenValidation() {
            const token = document.getElementById('testToken').value;
            const resultDiv = document.getElementById('validationResult');
            
            try {
                const validToken = MockPasswordResetStorage.validateToken(token);
                if (validToken) {
                    resultDiv.innerHTML = `<div class="success">✅ Token is valid. Email: ${validToken.email}</div>`;
                    testResults.push({ test: 'Token Validation', status: 'PASS', details: `Valid for: ${validToken.email}` });
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ Token is invalid or expired</div>`;
                    testResults.push({ test: 'Token Validation', status: 'FAIL', details: 'Invalid or expired token' });
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Token validation failed: ${error.message}</div>`;
                testResults.push({ test: 'Token Validation', status: 'FAIL', details: error.message });
            }
            updateSummary();
        }

        function testPasswordUpdate() {
            const token = document.getElementById('testToken').value;
            const newPassword = document.getElementById('newPassword').value;
            const resultDiv = document.getElementById('updateResult');
            
            try {
                const validToken = MockPasswordResetStorage.validateToken(token);
                if (!validToken) {
                    resultDiv.innerHTML = `<div class="error">❌ Invalid token for password update</div>`;
                    testResults.push({ test: 'Password Update', status: 'FAIL', details: 'Invalid token' });
                    updateSummary();
                    return;
                }
                
                const success = MockUserStorage.updatePassword(validToken.userId, newPassword);
                if (success) {
                    MockPasswordResetStorage.markTokenAsUsed(token);
                    resultDiv.innerHTML = `<div class="success">✅ Password updated successfully</div>`;
                    testResults.push({ test: 'Password Update', status: 'PASS', details: 'Password updated and token marked as used' });
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ Failed to update password</div>`;
                    testResults.push({ test: 'Password Update', status: 'FAIL', details: 'User not found' });
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Password update failed: ${error.message}</div>`;
                testResults.push({ test: 'Password Update', status: 'FAIL', details: error.message });
            }
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('testSummary');
            const passCount = testResults.filter(r => r.status === 'PASS').length;
            const failCount = testResults.filter(r => r.status === 'FAIL').length;
            
            let summaryHTML = `<h3>Test Results: ${passCount} PASS, ${failCount} FAIL</h3>`;
            testResults.forEach(result => {
                const statusClass = result.status === 'PASS' ? 'success' : 'error';
                summaryHTML += `<div class="${statusClass}">
                    <strong>${result.test}:</strong> ${result.status} - ${result.details}
                </div>`;
            });
            
            summaryDiv.innerHTML = summaryHTML;
        }

        // Auto-run basic tests on page load
        window.onload = function() {
            console.log('Password Reset Test Page Loaded');
            console.log('Available tests:');
            console.log('1. Token Generation');
            console.log('2. Token Validation');
            console.log('3. Password Update');
        };
    </script>
</body>
</html>
